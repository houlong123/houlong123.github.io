<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Spring AOP源码学习 | 而今伊始，命途自闯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="AOP基础知识AOP(Aspect-Oriented Programming)：面向切面编程。OOP(Object-Oriented Programming)面向对象的编程。其实AOP是对OOP的一种补充。OOP面向的是纵向编程，继承，封装，多态是其三大特性，而AOP是面向横向编程。在OOP中，模块化的关键是类(class)，而在AOP中，模块化的关键是切面(aspect)。 AOP概念术语 切面">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring AOP源码学习">
<meta property="og:url" content="https://houlong123.github.io/2017/08/22/Spring-AOP源码学习/index.html">
<meta property="og:site_name" content="而今伊始，命途自闯">
<meta property="og:description" content="AOP基础知识AOP(Aspect-Oriented Programming)：面向切面编程。OOP(Object-Oriented Programming)面向对象的编程。其实AOP是对OOP的一种补充。OOP面向的是纵向编程，继承，封装，多态是其三大特性，而AOP是面向横向编程。在OOP中，模块化的关键是类(class)，而在AOP中，模块化的关键是切面(aspect)。 AOP概念术语 切面">
<meta property="og:image" content="http://thumbsnap.com/i/NdzbZHJ7.jpg">
<meta property="og:updated_time" content="2018-01-25T06:14:34.859Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring AOP源码学习">
<meta name="twitter:description" content="AOP基础知识AOP(Aspect-Oriented Programming)：面向切面编程。OOP(Object-Oriented Programming)面向对象的编程。其实AOP是对OOP的一种补充。OOP面向的是纵向编程，继承，封装，多态是其三大特性，而AOP是面向横向编程。在OOP中，模块化的关键是类(class)，而在AOP中，模块化的关键是切面(aspect)。 AOP概念术语 切面">
<meta name="twitter:image" content="http://thumbsnap.com/i/NdzbZHJ7.jpg">
  
    <link rel="alternate" href="/atom.xml" title="而今伊始，命途自闯" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">而今伊始，命途自闯</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://houlong123.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Spring-AOP源码学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/22/Spring-AOP源码学习/" class="article-date">
  <time datetime="2017-08-22T06:13:31.000Z" itemprop="datePublished">2017-08-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring AOP源码学习
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="AOP基础知识"><a href="#AOP基础知识" class="headerlink" title="AOP基础知识"></a>AOP基础知识</h4><p>AOP(Aspect-Oriented Programming)：面向切面编程。OOP(Object-Oriented Programming)面向对象的编程。其实AOP是对OOP的一种补充。OOP面向的是纵向编程，<code>继承，封装，多态</code>是其三大特性，而AOP是面向横向编程。在OOP中，模块化的关键是<code>类(class)</code>，而在AOP中，模块化的关键是<code>切面(aspect)</code>。</p>
<h5 id="AOP概念术语"><a href="#AOP概念术语" class="headerlink" title="AOP概念术语"></a>AOP概念术语</h5><ul>
<li><strong>切面(Aspect)</strong>：一个关注点的模块化，这个关注点可能会横切多个对象。</li>
<li><strong>连接点(Joinpoint)</strong>：在程序执行过程中某个特定的点。在Spring AOP中，<code>一个连接点总是表示一个方法的执行</code>。</li>
<li><strong>通知(Advice)</strong>：在切面的某个特定的连接点上执行的动作。包括：<code>around</code>, <code>before</code>, <code>after</code>等不同类型的通知。</li>
<li><strong>切入点(Pointcut)</strong>：匹配连接点的断言。通知和一个切入点表达式关联，并在满足这个切入点的连接点上运行。</li>
<li><strong>引入(Introduction)</strong>：用来给一个类型说明额外的方法或者属性。</li>
<li><strong>目标对象(Target Object)</strong>：被一个或者多个切面所通知的对象。既然Spring AOP是通过运行时代理实现的，这个对象永远是一个被代理（proxied）对象。</li>
<li><strong>AOP代理(AOP Proxy)</strong>：AOP框架创建的对象，用来实现切面契约（例如通知方法执行等等）。在Spring中，AOP代理可以是<a href="https://houlong123.github.io/2017/07/31/AOP%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">JDK动态代理或者CGLIB代理</a>。</li>
<li><strong>织入(Weaving)</strong>：把切面连接到其他的应用程序类型或者对象上，并创建一个被通知的对象。</li>
</ul>
<a id="more"></a>
<h5 id="AOP通知类型"><a href="#AOP通知类型" class="headerlink" title="AOP通知类型"></a>AOP通知类型</h5><ul>
<li><strong>前置通知(Before advice)</strong>：在某连接点之前执行的通知，但这个通知不能阻止连接点之前的执行流程（除非它抛出一个异常）。</li>
<li><strong>后置通知(After returning advice)</strong>：在某连接点正常完成后执行 的通知。</li>
<li><strong>异常通知(After throwing advide)</strong>：在方法抛出异常退出时执行的通知。</li>
<li><strong>最终通知(After finally advice)</strong>：当某连接点退出的时候执行的通知(不论是正常返回还是异常退出)。</li>
<li><strong>环绕通知(Around Advice)</strong>：包围一个连接点的通知，环绕通知可以在方法调用前后完成自定义的行为。它也会选择是否继续执行连接点或直接返回它自己的返回值或抛出异常来结束执行。</li>
</ul>
<h4 id="AOP源码解析之xml文件读取"><a href="#AOP源码解析之xml文件读取" class="headerlink" title="AOP源码解析之xml文件读取"></a>AOP源码解析之xml文件读取</h4><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Dao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoImpl</span> <span class="keyword">extends</span> <span class="title">Dao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Enter DaoImpl.select()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Enter DaoImpl.insert()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在AOP中，扮演横切关注点角色</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"CurrentTime: "</span> + System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/aop/spring-aop-3.0.xsd"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"daoImpl"</span> <span class="attr">class</span>=<span class="string">"org.xrq.action.aop.DaoImpl"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"timeHandler"</span> <span class="attr">class</span>=<span class="string">"org.xrq.action.aop.TimeHandler"</span> /&gt;</span></span><br><span class="line"> </span><br><span class="line">     <span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"time"</span> <span class="attr">ref</span>=<span class="string">"timeHandler"</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"addAllMethod"</span> <span class="attr">expression</span>=<span class="string">"execution(* org.xrq.action.aop.Dao.*(..))"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"printTime"</span> <span class="attr">pointcut-ref</span>=<span class="string">"addAllMethod"</span> /&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"printTime"</span> <span class="attr">pointcut-ref</span>=<span class="string">"addAllMethod"</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line">     </span><br><span class="line"> <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestAop</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring/aop.xml"</span>);</span><br><span class="line">        Dao dao = (Dao) ac.getBean(<span class="string">"daoImpl"</span>);</span><br><span class="line">        dao.select();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output</span></span><br><span class="line">CurrentTime: <span class="number">1231223432</span></span><br><span class="line">Enter DaoImpl.select()</span><br><span class="line">CurrentTime: <span class="number">1231223532</span></span><br></pre></td></tr></table></figure>
<p>在文章<a href="https://houlong123.github.io/2017/08/10/Bean%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86%E4%B9%8BBeanDefinitions%E5%8A%A0%E8%BD%BD/">Bean加载流程梳理之BeanDefinitions加载</a>中，已知xml文件的解析是发生在DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法中。</p>
<h5 id="parseBeanDefinitions源码"><a href="#parseBeanDefinitions源码" class="headerlink" title="parseBeanDefinitions源码"></a>parseBeanDefinitions源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">            NodeList nl = root.getChildNodes();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); ++i) &#123;</span><br><span class="line">                Node node = nl.item(i);</span><br><span class="line">                <span class="keyword">if</span>(node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">                    Element ele = (Element)node;</span><br><span class="line">                    <span class="keyword">if</span>(delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.parseDefaultElement(ele, delegate);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        delegate.parseCustomElement(ele);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            delegate.parseCustomElement(root);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>由源码可知，xml配置文件中的<code>&lt;import&gt;</code>, <code>&lt;alias&gt;</code>, <code>&lt;bean&gt;</code>, <code>&lt;beans&gt;</code>元素交由<code>parseDefaultElement</code>方法处理，其他标签则交由<code>parseCustomElement</code>方法处理。</p>
<h5 id="parseCustomElement源码"><a href="#parseCustomElement源码" class="headerlink" title="parseCustomElement源码"></a>parseCustomElement源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, BeanDefinition containingBd)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//&lt;aop:config&gt;这个Node（参数Element是Node接口的子接口）中拿到Namespace="http://www.springframework.org/schema/aop"</span></span><br><span class="line">        String namespaceUri = <span class="keyword">this</span>.getNamespaceURI(ele);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//根据这个Namespace获取对应的NamespaceHandler即Namespace处理器，具体到aop这个Namespace的NamespaceHandler是org.springframework.beans.factory.xml.NamespaceHandlerSupport类。</span></span><br><span class="line">        NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">        <span class="keyword">if</span>(handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.error(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, ele);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在Spring AOP中，有几个Parser用于具体标签转换的：</p>
<table>
<thead>
<tr>
<th>标签</th>
<th>parser处理类</th>
</tr>
</thead>
<tbody>
<tr>
<td>aop:config</td>
<td>ConfigBeanDefinitionParser</td>
</tr>
<tr>
<td>aop:aspectj-autoproxy</td>
<td>AspectJAutoProxyBeanDefinitionParser</td>
</tr>
<tr>
<td>aop:scoped-proxy</td>
<td>ScopedProxyBeanDefinitionDecorator</td>
</tr>
</tbody>
</table>
<h5 id="NamespaceHandlerSupport类中parse源码"><a href="#NamespaceHandlerSupport类中parse源码" class="headerlink" title="NamespaceHandlerSupport类中parse源码"></a>NamespaceHandlerSupport类中parse源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//由上面的表格可知，具体的parser为ConfigBeanDefinitionParser</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.findParserForElement(element, parserContext).parse(element, parserContext);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="ConfigBeanDefinitionParser类中parse源码"><a href="#ConfigBeanDefinitionParser类中parse源码" class="headerlink" title="ConfigBeanDefinitionParser类中parse源码"></a>ConfigBeanDefinitionParser类中parse源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">        CompositeComponentDefinition compositeDef = <span class="keyword">new</span> CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element));</span><br><span class="line">        parserContext.pushContainingComponent(compositeDef);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 完成两个功能：</span></span><br><span class="line"><span class="comment">         * 1. 向Spring容器注册了一个BeanName为org.springframework.aop.config.internalAutoProxyCreator的Bean定义，可以自定义也可以使用Spring提供的（根据优先级来）</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 2. Spring默认提供的是org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator，这个类是AOP的核心类</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 3.根据配置proxy-target-class和expose-proxy，设置是否使用CGLIB进行代理以及是否暴露最终的代理。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">this</span>.configureAutoProxyCreator(parserContext, element);</span><br><span class="line">        </span><br><span class="line">        List childElts = DomUtils.getChildElements(element);</span><br><span class="line">        Iterator var5 = childElts.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">            Element elt = (Element)var5.next();</span><br><span class="line">            String localName = parserContext.getDelegate().getLocalName(elt);</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"pointcut"</span>.equals(localName)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.parsePointcut(elt, parserContext);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"advisor"</span>.equals(localName)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.parseAdvisor(elt, parserContext);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"aspect"</span>.equals(localName)) &#123;  <span class="comment">//&lt;aop:config&gt;下的节点为&lt;aop:aspect&gt;,因此会执行下面代码</span></span><br><span class="line">                <span class="keyword">this</span>.parseAspect(elt, parserContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parserContext.popAndRegisterContainingComponent();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="parseAspect源码"><a href="#parseAspect源码" class="headerlink" title="parseAspect源码"></a>parseAspect源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAspect</span><span class="params">(Element aspectElement, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//根据配置&lt;aop:aspect id="time" ref="timeHandler"&gt;，获取切面ID及切面名</span></span><br><span class="line">        String aspectId = aspectElement.getAttribute(<span class="string">"id"</span>);</span><br><span class="line">        String aspectName = aspectElement.getAttribute(<span class="string">"ref"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> AspectEntry(aspectId, aspectName));</span><br><span class="line">            ArrayList beanDefinitions = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            ArrayList beanReferences = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            List declareParents = DomUtils.getChildElementsByTagName(aspectElement, <span class="string">"declare-parents"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> nodeList = <span class="number">0</span>; nodeList &lt; declareParents.size(); ++nodeList) &#123;</span><br><span class="line">                Element adviceFoundAlready = (Element)declareParents.get(nodeList);</span><br><span class="line">                beanDefinitions.add(<span class="keyword">this</span>.parseDeclareParents(adviceFoundAlready, parserContext));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取&lt;aop:aspect&gt;的子元素，遍历</span></span><br><span class="line">            NodeList var17 = aspectElement.getChildNodes();</span><br><span class="line">            <span class="keyword">boolean</span> var18 = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> aspectComponentDefinition = <span class="number">0</span>; aspectComponentDefinition &lt; var17.getLength(); ++aspectComponentDefinition) &#123;</span><br><span class="line">                Node pointcuts = var17.item(aspectComponentDefinition);</span><br><span class="line">               </span><br><span class="line">                <span class="comment">//由isAdviceNode方法可知，只用来处理&lt;aop:aspect&gt;标签下的&lt;aop:before&gt;、&lt;aop:after&gt;、&lt;aop:after-returning&gt;、&lt;aop:after-throwing method=""&gt;、&lt;aop:around method=""&gt;这五个标签的。</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.isAdviceNode(pointcuts, parserContext)) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!var18) &#123;</span><br><span class="line">                        var18 = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">if</span>(!StringUtils.hasText(aspectName)) &#123;</span><br><span class="line">                            parserContext.getReaderContext().error(<span class="string">"&lt;aspect&gt; tag needs aspect bean reference via \'ref\' attribute when declaring advices."</span>, aspectElement, <span class="keyword">this</span>.parseState.snapshot());</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        beanReferences.add(<span class="keyword">new</span> RuntimeBeanReference(aspectName));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//如果是五种通知类型之一的话，执行下面语句</span></span><br><span class="line">                    AbstractBeanDefinition advisorDefinition = <span class="keyword">this</span>.parseAdvice(aspectName, aspectComponentDefinition, aspectElement, (Element)pointcuts, parserContext, beanDefinitions, beanReferences);</span><br><span class="line">                    beanDefinitions.add(advisorDefinition);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            AspectComponentDefinition var19 = <span class="keyword">this</span>.createAspectComponentDefinition(aspectElement, aspectId, beanDefinitions, beanReferences, parserContext);</span><br><span class="line">            parserContext.pushContainingComponent(var19);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//处理&lt;aop:pointcut&gt;流程</span></span><br><span class="line">            List var20 = DomUtils.getChildElementsByTagName(aspectElement, <span class="string">"pointcut"</span>);</span><br><span class="line">            Iterator var21 = var20.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var21.hasNext()) &#123;</span><br><span class="line">                Element pointcutElement = (Element)var21.next();</span><br><span class="line">                <span class="keyword">this</span>.parsePointcut(pointcutElement, parserContext);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            parserContext.popAndRegisterContainingComponent();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="parseAdvice源码"><a href="#parseAdvice源码" class="headerlink" title="parseAdvice源码"></a>parseAdvice源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">parseAdvice</span><span class="params">(String aspectName, <span class="keyword">int</span> order, Element aspectElement, Element adviceElement, ParserContext parserContext, List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences)</span> </span>&#123;</span><br><span class="line">        RootBeanDefinition var12;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> AdviceEntry(parserContext.getDelegate().getLocalName(adviceElement)));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// create the method factory bean</span></span><br><span class="line">            RootBeanDefinition methodDefinition = <span class="keyword">new</span> RootBeanDefinition(MethodLocatingFactoryBean.class);</span><br><span class="line">            methodDefinition.getPropertyValues().add(<span class="string">"targetBeanName"</span>, aspectName);</span><br><span class="line">            methodDefinition.getPropertyValues().add(<span class="string">"methodName"</span>, adviceElement.getAttribute(<span class="string">"method"</span>));</span><br><span class="line">            methodDefinition.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//create instance factory definition</span></span><br><span class="line">            RootBeanDefinition aspectFactoryDef = <span class="keyword">new</span> RootBeanDefinition(SimpleBeanFactoryAwareAspectInstanceFactory.class);</span><br><span class="line">            aspectFactoryDef.getPropertyValues().add(<span class="string">"aspectBeanName"</span>, aspectName);</span><br><span class="line">            aspectFactoryDef.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//register the pointcut。根据织入方式将&lt;aop:before&gt;、&lt;aop:after&gt;转换成名为adviceDef的RootBeanDefinition</span></span><br><span class="line">            AbstractBeanDefinition adviceDef = <span class="keyword">this</span>.createAdviceDefinition(adviceElement, parserContext, aspectName, order, methodDefinition, aspectFactoryDef, beanDefinitions, beanReferences);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//configure the advisor。将名为adviceDef的RootBeanDefinition转换成名为advisorDefinition的RootBeanDefinition</span></span><br><span class="line">            RootBeanDefinition advisorDefinition = <span class="keyword">new</span> RootBeanDefinition(AspectJPointcutAdvisor.class);</span><br><span class="line">            advisorDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line">            advisorDefinition.getConstructorArgumentValues().addGenericArgumentValue(adviceDef);</span><br><span class="line">            <span class="keyword">if</span>(aspectElement.hasAttribute(<span class="string">"order"</span>)) &#123;</span><br><span class="line">                advisorDefinition.getPropertyValues().add(<span class="string">"order"</span>, aspectElement.getAttribute(<span class="string">"order"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//register the final advisor。将BeanDefinition注册到DefaultListableBeanFactory中</span></span><br><span class="line">            parserContext.getReaderContext().registerWithGeneratedName(advisorDefinition);</span><br><span class="line">            var12 = advisorDefinition;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var12;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>功能：</p>
<ol>
<li>根据织入方式（before、after这些）创建RootBeanDefinition，名为adviceDef即advice定义</li>
<li>将上一步创建的RootBeanDefinition写入一个新的RootBeanDefinition，构造一个新的对象，名为advisorDefinition，即advisor定义</li>
<li>将advisorDefinition注册到DefaultListableBeanFactory中</li>
</ol>
<h5 id="createAdviceDefinition源码"><a href="#createAdviceDefinition源码" class="headerlink" title="createAdviceDefinition源码"></a>createAdviceDefinition源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">createAdviceDefinition</span><span class="params">(Element adviceElement, ParserContext parserContext, String aspectName, <span class="keyword">int</span> order, RootBeanDefinition methodDef, RootBeanDefinition aspectFactoryDef, List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//创建的AbstractBeanDefinition实例是RootBeanDefinition，这和普通Bean创建的实例为GenericBeanDefinition不同</span></span><br><span class="line">        RootBeanDefinition adviceDefinition = <span class="keyword">new</span> RootBeanDefinition(<span class="keyword">this</span>.getAdviceClass(adviceElement, parserContext));</span><br><span class="line">        adviceDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line">        adviceDefinition.getPropertyValues().add(<span class="string">"aspectName"</span>, aspectName);</span><br><span class="line">        adviceDefinition.getPropertyValues().add(<span class="string">"declarationOrder"</span>, Integer.valueOf(order));</span><br><span class="line">        <span class="keyword">if</span>(adviceElement.hasAttribute(<span class="string">"returning"</span>)) &#123;</span><br><span class="line">            adviceDefinition.getPropertyValues().add(<span class="string">"returningName"</span>, adviceElement.getAttribute(<span class="string">"returning"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(adviceElement.hasAttribute(<span class="string">"throwing"</span>)) &#123;</span><br><span class="line">            adviceDefinition.getPropertyValues().add(<span class="string">"throwingName"</span>, adviceElement.getAttribute(<span class="string">"throwing"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(adviceElement.hasAttribute(<span class="string">"arg-names"</span>)) &#123;</span><br><span class="line">            adviceDefinition.getPropertyValues().add(<span class="string">"argumentNames"</span>, adviceElement.getAttribute(<span class="string">"arg-names"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ConstructorArgumentValues cav = adviceDefinition.getConstructorArgumentValues();</span><br><span class="line">        cav.addIndexedArgumentValue(<span class="number">0</span>, methodDef);</span><br><span class="line">        Object pointcut = <span class="keyword">this</span>.parsePointcutProperty(adviceElement, parserContext);</span><br><span class="line">        <span class="keyword">if</span>(pointcut <span class="keyword">instanceof</span> BeanDefinition) &#123;</span><br><span class="line">            cav.addIndexedArgumentValue(<span class="number">1</span>, pointcut);</span><br><span class="line">            beanDefinitions.add((BeanDefinition)pointcut);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(pointcut <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            RuntimeBeanReference pointcutRef = <span class="keyword">new</span> RuntimeBeanReference((String)pointcut);</span><br><span class="line">            cav.addIndexedArgumentValue(<span class="number">1</span>, pointcutRef);</span><br><span class="line">            beanReferences.add(pointcutRef);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cav.addIndexedArgumentValue(<span class="number">2</span>, aspectFactoryDef);</span><br><span class="line">        <span class="keyword">return</span> adviceDefinition;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="getAdviceClass源码"><a href="#getAdviceClass源码" class="headerlink" title="getAdviceClass源码"></a>getAdviceClass源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdviceClass(Element adviceElement, ParserContext parserContext) &#123;</span><br><span class="line">        String elementName = parserContext.getDelegate().getLocalName(adviceElement);</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"before"</span>.equals(elementName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AspectJMethodBeforeAdvice.class;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"after"</span>.equals(elementName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AspectJAfterAdvice.class;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"after-returning"</span>.equals(elementName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AspectJAfterReturningAdvice.class;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"after-throwing"</span>.equals(elementName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AspectJAfterThrowingAdvice.class;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"around"</span>.equals(elementName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AspectJAroundAdvice.class;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown advice kind ["</span> + elementName + <span class="string">"]."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>既然创建Bean定义，必然该Bean定义中要对应一个具体的Class，不同的切入方式对应不同的Class：</p>
<table>
<thead>
<tr>
<th>通知类型</th>
<th>对应Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>before</td>
<td>AspectJMethodBeforeAdvice</td>
</tr>
<tr>
<td>after</td>
<td>AspectJAfterAdvice</td>
</tr>
<tr>
<td>after-returning</td>
<td>AspectJAfterReturningAdvice</td>
</tr>
<tr>
<td>after-throwing</td>
<td>AspectJAfterThrowingAdvice</td>
</tr>
<tr>
<td>around</td>
<td>AspectJAroundAdvice</td>
</tr>
</tbody>
</table>
<h5 id="parsePointcut源码"><a href="#parsePointcut源码" class="headerlink" title="parsePointcut源码"></a>parsePointcut源码</h5><p>在ConfigBeanDefinitionParser类的parseAspect方法处理中，在处理完advice后，会执行parsePointcut进行<code>&lt;aop:pointcut&gt;</code>的解析。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">parsePointcut</span><span class="params">(Element pointcutElement, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取&lt;aop:pointcut&gt;标签下的"id"属性与"expression"属性</span></span><br><span class="line">        String id = pointcutElement.getAttribute(<span class="string">"id"</span>);</span><br><span class="line">        String expression = pointcutElement.getAttribute(<span class="string">"expression"</span>);</span><br><span class="line">        AbstractBeanDefinition pointcutDefinition = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//推送一个PointcutEntry，表示当前Spring上下文正在解析Pointcut标签</span></span><br><span class="line">            <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PointcutEntry(id));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//创建Pointcut的Bean定义</span></span><br><span class="line">            pointcutDefinition = <span class="keyword">this</span>.createPointcutDefinition(expression);</span><br><span class="line">            pointcutDefinition.setSource(parserContext.extractSource(pointcutElement));</span><br><span class="line">            String pointcutBeanName = id;</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.hasText(id)) &#123;   <span class="comment">//如果&lt;aop:pointcut&gt;标签中配置了id属性就执行</span></span><br><span class="line">                parserContext.getRegistry().registerBeanDefinition(id, pointcutDefinition);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;    <span class="comment">//如果&lt;aop:pointcut&gt;标签中没有配置id属性就执行,和Bean不配置id属性一样的规则,pointcutBeanName=org.springframework.aop.aspectj.AspectJExpressionPointcut#序号（从0开始累加）</span></span><br><span class="line">                pointcutBeanName = parserContext.getReaderContext().registerWithGeneratedName(pointcutDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//向解析工具上下文中注册一个Pointcut组件定义</span></span><br><span class="line">            parserContext.registerComponent(<span class="keyword">new</span> PointcutComponentDefinition(pointcutBeanName, pointcutDefinition, expression));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//在&lt;aop:pointcut&gt;标签解析完毕后，让之前推送至栈顶的PointcutEntry出栈，表示此次&lt;aop:pointcut&gt;标签解析完毕。</span></span><br><span class="line">            <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pointcutDefinition;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="createPointcutDefinition源码"><a href="#createPointcutDefinition源码" class="headerlink" title="createPointcutDefinition源码"></a>createPointcutDefinition源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AbstractBeanDefinition <span class="title">createPointcutDefinition</span><span class="params">(String expression)</span> </span>&#123;</span><br><span class="line">        RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition(AspectJExpressionPointcut.class);</span><br><span class="line">        beanDefinition.setScope(<span class="string">"prototype"</span>);</span><br><span class="line">        beanDefinition.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line">        beanDefinition.getPropertyValues().add(<span class="string">"expression"</span>, expression);</span><br><span class="line">        <span class="keyword">return</span> beanDefinition;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>关键点：</p>
<ol>
<li><aop:pointcut>标签对应解析出来的BeanDefinition是RootBeanDefinition，且RootBenaDefinitoin中的Class是org.springframework.aop.aspectj.AspectJExpressionPointcut</aop:pointcut></li>
<li><aop:pointcut>标签对应的Bean是prototype即原型的</aop:pointcut></li>
</ol>
<p>整个流程下来，就解析了<code>&lt;aop:pointcut&gt;</code>标签中的内容并将之转换为RootBeanDefintion存储在Spring容器中。</p>
<h4 id="AOP关键类AspectJAwareAdvisorAutoProxyCreator解析"><a href="#AOP关键类AspectJAwareAdvisorAutoProxyCreator解析" class="headerlink" title="AOP关键类AspectJAwareAdvisorAutoProxyCreator解析"></a>AOP关键类AspectJAwareAdvisorAutoProxyCreator解析</h4><p>在读取AOP配置文件时，可知<code>org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator</code>这个类是Spring AOP的核心类，就是AspectJAwareAdvisorAutoProxyCreator完成了【类/接口–&gt;代理】的转换过程。</p>
<p>类图：<br><img src="http://thumbsnap.com/i/NdzbZHJ7.jpg" alt="AspectJAwareAdvisorAutoProxyCreator继承图"><br>由类图，可知：</p>
<ol>
<li>AspectJAwareAdvisorAutoProxyCreator实现了BeanPostProcessor接口。</li>
<li>在每个Bean初始化之后，如果需要，调用AspectJAwareAdvisorAutoProxyCreator中的<code>postProcessBeforeInitialization</code>或者<code>postProcessAfterInitialization</code>为Bean生成代理。</li>
</ol>
<h5 id="AOP代理类生成"><a href="#AOP代理类生成" class="headerlink" title="AOP代理类生成"></a>AOP代理类生成</h5><p>在 <a href="https://houlong123.github.io/2017/08/12/Bean%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%B9%8BBeanWrapper%E6%9E%84%E5%BB%BA/">Bean加载流程之BeanWrapper构建</a> 文章中，讲解到了对非懒加载Bean的初始化。</p>
<h5 id="initializeBean源码"><a href="#initializeBean源码" class="headerlink" title="initializeBean源码"></a>initializeBean源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">initializeBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean, RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    AbstractAutowireCapableBeanFactory.<span class="keyword">this</span>.invokeAwareMethods(beanName, bean);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">this</span>.getAccessControlContext());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//Aware注入。在使用Spring的时候我们将自己的Bean实现BeanNameAware接口、BeanFactoryAware接口等，依赖容器帮我们注入当前Bean的名称或者Bean工厂</span></span><br><span class="line">            <span class="keyword">this</span>.invokeAwareMethods(beanName, bean);</span><br><span class="line">        &#125;</span><br><span class="line">        Object wrappedBean = bean;</span><br><span class="line">        <span class="keyword">if</span>(mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">            <span class="comment">//执行BeanPostProcessor接口方法，在bean初始化之前执行</span></span><br><span class="line">            wrappedBean = <span class="keyword">this</span>.applyBeanPostProcessorsBeforeInitialization(bean, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//如果bean实现了InitializingBean或者设置了init-method属性，则执行相应的操作</span></span><br><span class="line">            <span class="keyword">this</span>.invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd != <span class="keyword">null</span>?mbd.getResourceDescription():<span class="keyword">null</span>, beanName, <span class="string">"Invocation of init method failed"</span>, var6);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">              <span class="comment">//执行BeanPostProcessor接口方法，在bean初始化之后执行</span></span><br><span class="line">            wrappedBean = <span class="keyword">this</span>.applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wrappedBean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>有上面代码可知，在bean初始化之前调用BeanPostProcessor接口的applyBeanPostProcessorsBeforeInitialization方法，初始化之后调用BeanPostProcessor接口的applyBeanPostProcessorsAfterInitialization方法。由源码可知，相应的applyBeanPostProcessorsBeforeInitialization方法没有添加任何多余的实现，代理类生成的逻辑代码在postProcessAfterInitialization方法中。</p>
<h5 id="applyBeanPostProcessorsAfterInitialization源码"><a href="#applyBeanPostProcessorsAfterInitialization源码" class="headerlink" title="applyBeanPostProcessorsAfterInitialization源码"></a>applyBeanPostProcessorsAfterInitialization源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        Object result = existingBean;</span><br><span class="line">        Iterator var4 = <span class="keyword">this</span>.getBeanPostProcessors().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!var4.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            BeanPostProcessor beanProcessor = (BeanPostProcessor)var4.next();</span><br><span class="line">            result = beanProcessor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">        &#125; <span class="keyword">while</span>(result != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>功能：循环调用每个BeanPostProcessor接口实现类的postProcessAfterInitialization方法，由之前的分析，可知，AOP代理类生成会进入<code>AbstractAutoProxyCreator</code>类</p>
<h5 id="postProcessAfterInitialization源码"><a href="#postProcessAfterInitialization源码" class="headerlink" title="postProcessAfterInitialization源码"></a>postProcessAfterInitialization源码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//AbstractAutoProxyCreator类中postProcessAfterInitialization方法</span><br><span class="line">public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">        if(bean != null) &#123;</span><br><span class="line">            Object cacheKey = this.getCacheKey(bean.getClass(), beanName);</span><br><span class="line">            if(!this.earlyProxyReferences.contains(cacheKey)) &#123;</span><br><span class="line">                return this.wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="wrapIfNecessary源码"><a href="#wrapIfNecessary源码" class="headerlink" title="wrapIfNecessary源码"></a>wrapIfNecessary源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(beanName != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.targetSourcedBeans.contains(beanName)) &#123; <span class="comment">//不需要生成代理的场景判断</span></span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(Boolean.FALSE.equals(<span class="keyword">this</span>.advisedBeans.get(cacheKey))) &#123; <span class="comment">//不需要生成代理的场景判断</span></span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">this</span>.isInfrastructureClass(bean.getClass()) &amp;&amp; !<span class="keyword">this</span>.shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">            <span class="comment">// 寻找合适的Advisor</span></span><br><span class="line">            Object[] specificInterceptors = <span class="keyword">this</span>.getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, (TargetSource)<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span>(specificInterceptors != DO_NOT_PROXY) &#123;  <span class="comment">//需要生成代理的目标对象不为空时</span></span><br><span class="line">                <span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">                <span class="comment">//为需要生成代理的目标对象创建代理</span></span><br><span class="line">                Object proxy = <span class="keyword">this</span>.createProxy(bean.getClass(), beanName, specificInterceptors, <span class="keyword">new</span> SingletonTargetSource(bean));</span><br><span class="line">                <span class="keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">                <span class="keyword">return</span> proxy;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>功能：上述源码的功能主要就是判断目标对象是否需要生成代理。需要，则创建代理类；不需要，则返回原类。</p>
<h5 id="findEligibleAdvisors源码"><a href="#findEligibleAdvisors源码" class="headerlink" title="findEligibleAdvisors源码"></a>findEligibleAdvisors源码</h5><p>在目标对象需要被代理时，需要为目标对象去寻找合适的Advisor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为指定class寻找合适的Advisor</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;Advisor&gt; <span class="title">findEligibleAdvisors</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//根据上文的配置文件,寻找所有候选Advisors。在XML解析的时候已经被转换生成了RootBeanDefinition。</span></span><br><span class="line">        List candidateAdvisors = <span class="keyword">this</span>.findCandidateAdvisors();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取匹配的Advisors</span></span><br><span class="line">        List eligibleAdvisors = <span class="keyword">this</span>.findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//向候选Advisor链的开头（也就是List.get(0)的位置添加一个org.springframework.aop.support.DefaultPointcutAdvisor。</span></span><br><span class="line">        <span class="keyword">this</span>.extendAdvisors(eligibleAdvisors);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!eligibleAdvisors.isEmpty()) &#123;</span><br><span class="line">            eligibleAdvisors = <span class="keyword">this</span>.sortAdvisors(eligibleAdvisors);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> eligibleAdvisors;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="findAdvisorsThatCanApply源码"><a href="#findAdvisorsThatCanApply源码" class="headerlink" title="findAdvisorsThatCanApply源码"></a>findAdvisorsThatCanApply源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;Advisor&gt; <span class="title">findAdvisorsThatCanApply</span><span class="params">(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName)</span> </span>&#123;</span><br><span class="line">        ProxyCreationContext.setCurrentProxiedBeanName(beanName);</span><br><span class="line"></span><br><span class="line">        List var4;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//调用AopUtils中相应方法</span></span><br><span class="line">            var4 = AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ProxyCreationContext.setCurrentProxiedBeanName((String)<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var4;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="AopUtils类中findAdvisorsThatCanApply源码"><a href="#AopUtils类中findAdvisorsThatCanApply源码" class="headerlink" title="AopUtils类中findAdvisorsThatCanApply源码"></a>AopUtils类中findAdvisorsThatCanApply源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AopUtils类中findAdvisorsThatCanApply源码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Advisor&gt; <span class="title">findAdvisorsThatCanApply</span><span class="params">(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(candidateAdvisors.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> candidateAdvisors;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LinkedList eligibleAdvisors = <span class="keyword">new</span> LinkedList();</span><br><span class="line">            Iterator hasIntroductions = candidateAdvisors.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(hasIntroductions.hasNext()) &#123;</span><br><span class="line">                Advisor candidate = (Advisor)hasIntroductions.next();</span><br><span class="line">                <span class="keyword">if</span>(candidate <span class="keyword">instanceof</span> IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123;</span><br><span class="line">                    eligibleAdvisors.add(candidate);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> hasIntroductions1 = !eligibleAdvisors.isEmpty();</span><br><span class="line">            Iterator candidate2 = candidateAdvisors.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(candidate2.hasNext()) &#123;</span><br><span class="line">                Advisor candidate1 = (Advisor)candidate2.next();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//PointcutAdvisor处理</span></span><br><span class="line">                <span class="keyword">if</span>(!(candidate1 <span class="keyword">instanceof</span> IntroductionAdvisor) &amp;&amp; canApply(candidate1, clazz, hasIntroductions1)) &#123;</span><br><span class="line">                    eligibleAdvisors.add(candidate1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> eligibleAdvisors;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>由源码可知，整个方法判断都是围绕<code>canApply</code>方法展开</p>
<h5 id="canApply源码"><a href="#canApply源码" class="headerlink" title="canApply源码"></a>canApply源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">canApply</span><span class="params">(Advisor advisor, Class&lt;?&gt; targetClass, <span class="keyword">boolean</span> hasIntroductions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(advisor <span class="keyword">instanceof</span> IntroductionAdvisor) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((IntroductionAdvisor)advisor).getClassFilter().matches(targetClass);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(advisor <span class="keyword">instanceof</span> PointcutAdvisor) &#123;  <span class="comment">//由于实例使用的是&lt;aop:pointcut&gt;,advisord的实际类型是AspectJPointcutAdvisor，是PointcutAdvisor的子类，因此下面代码执行</span></span><br><span class="line">            PointcutAdvisor pca = (PointcutAdvisor)advisor;</span><br><span class="line">            <span class="keyword">return</span> canApply(pca.getPointcut(), targetClass, hasIntroductions);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="canApply源码-1"><a href="#canApply源码-1" class="headerlink" title="canApply源码"></a>canApply源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例中实际类型是AspectJPointcutAdvisor，是PointcutAdvisor的子类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">canApply</span><span class="params">(Pointcut pc, Class&lt;?&gt; targetClass, <span class="keyword">boolean</span> hasIntroductions)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(pc, <span class="string">"Pointcut must not be null"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!pc.getClassFilter().matches(targetClass)) &#123;  <span class="comment">//是否匹配&lt;aop:pointcut id="addAllMethod" expression="execution(* org.xrq.action.aop.Dao.*(..))" /&gt;中的expression表达式，不匹配，返回false</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//判断目标类中的方法是否匹配&lt;aop:pointcut&gt;中的expression表达式</span></span><br><span class="line">            MethodMatcher methodMatcher = pc.getMethodMatcher();</span><br><span class="line">            <span class="keyword">if</span>(methodMatcher == MethodMatcher.TRUE) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                IntroductionAwareMethodMatcher introductionAwareMethodMatcher = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(methodMatcher <span class="keyword">instanceof</span> IntroductionAwareMethodMatcher) &#123;</span><br><span class="line">                    introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher)methodMatcher;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//获取目标类的所有实现接口</span></span><br><span class="line">                LinkedHashSet classes = <span class="keyword">new</span> LinkedHashSet(ClassUtils.getAllInterfacesForClassAsSet(targetClass));</span><br><span class="line">                classes.add(targetClass);</span><br><span class="line">                Iterator var6 = classes.iterator();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//循环遍历目标类所实现接口中的所有方法，判断是否匹配&lt;aop:pointcut&gt;中的expression表达式，只要有一个匹配，则返回true</span></span><br><span class="line">                <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                    Class clazz = (Class)var6.next();</span><br><span class="line">                    Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz);</span><br><span class="line">                    Method[] var9 = methods;</span><br><span class="line">                    <span class="keyword">int</span> var10 = methods.length;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> var11 = <span class="number">0</span>; var11 &lt; var10; ++var11) &#123;</span><br><span class="line">                        Method method = var9[var11];</span><br><span class="line">                        <span class="keyword">if</span>(introductionAwareMethodMatcher != <span class="keyword">null</span> &amp;&amp; introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) || methodMatcher.matches(method, targetClass)) &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>以上源码主要是获取Advisor数组。在Advisor数组不为空时，进入目标类的代理类创建流程。</p>
<h5 id="createProxy源码"><a href="#createProxy源码" class="headerlink" title="createProxy源码"></a>createProxy源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createProxy</span><span class="params">(Class&lt;?&gt; beanClass, String beanName, Object[] specificInterceptors, TargetSource targetSource)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;</span><br><span class="line">           AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory)<span class="keyword">this</span>.beanFactory, beanName, beanClass);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ProxyFactory proxyFactory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">       proxyFactory.copyFrom(<span class="keyword">this</span>);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//判断&lt;aop:config&gt;这个节点中proxy-target-class的配置，为true，即使用CGLIB生成代理</span></span><br><span class="line">       <span class="keyword">if</span>(!proxyFactory.isProxyTargetClass()) &#123;</span><br><span class="line">           <span class="keyword">if</span>(<span class="keyword">this</span>.shouldProxyTargetClass(beanClass, beanName)) &#123;</span><br><span class="line">               proxyFactory.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//获取当前Bean实现的所有接口，讲这些接口Class对象都添加到ProxyFactory中。</span></span><br><span class="line">                <span class="keyword">this</span>.evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//配置proxyFactory</span></span><br><span class="line">       Advisor[] advisors = <span class="keyword">this</span>.buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">       Advisor[] var7 = advisors;</span><br><span class="line">       <span class="keyword">int</span> var8 = advisors.length;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> var9 = <span class="number">0</span>; var9 &lt; var8; ++var9) &#123;</span><br><span class="line">           Advisor advisor = var7[var9];</span><br><span class="line">           proxyFactory.addAdvisor(advisor);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       proxyFactory.setTargetSource(targetSource);</span><br><span class="line">       <span class="keyword">this</span>.customizeProxyFactory(proxyFactory);</span><br><span class="line">       proxyFactory.setFrozen(<span class="keyword">this</span>.freezeProxy);</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.advisorsPreFiltered()) &#123;</span><br><span class="line">           proxyFactory.setPreFiltered(<span class="keyword">true</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="comment">//创建代理类</span></span><br><span class="line">       <span class="keyword">return</span> proxyFactory.getProxy(<span class="keyword">this</span>.getProxyClassLoader());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="getProxy源码"><a href="#getProxy源码" class="headerlink" title="getProxy源码"></a>getProxy源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.createAopProxy().getProxy(classLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>由源码可知，Spring框架会去获取AopProxy对象，即使用JDK代理还是使用Cglib代理。跟踪createAopProxy方法，最终定位到<code>DefaultAopProxyFactory</code>类中的createAopProxy方法。</p>
<h5 id="DefaultAopProxyFactory类createAopProxy源码"><a href="#DefaultAopProxyFactory类createAopProxy源码" class="headerlink" title="DefaultAopProxyFactory类createAopProxy源码"></a>DefaultAopProxyFactory类createAopProxy源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!config.isOptimize() &amp;&amp; !config.isProxyTargetClass() &amp;&amp; !<span class="keyword">this</span>.hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Class targetClass = config.getTargetClass();</span><br><span class="line">            <span class="keyword">if</span>(targetClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"TargetSource cannot determine target class: Either an interface or a target is required for proxy creation."</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (AopProxy)(!targetClass.isInterface() &amp;&amp; !Proxy.isProxyClass(targetClass)?<span class="keyword">new</span> ObjenesisCglibAopProxy(config):<span class="keyword">new</span> JdkDynamicAopProxy(config));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>功能分析：</p>
<ol>
<li><p>使用JDK代理的情况</p>
<ul>
<li>当ProxyConfig的isOptimize方法为false，即<code>不让Spring自己去优化</code></li>
<li>ProxyConfig的isProxyTargetClass方法为false，即<code>配置了proxy-target-class=&quot;false&quot;</code></li>
<li>ProxyConfig满足hasNoUserSuppliedProxyInterfaces方法执行结果为false，即<code>&lt;bean&gt;对象实现除SpringProxy接口之外的其他接口</code></li>
</ul>
</li>
<li><p>使用CGLIB代理的情况</p>
<ul>
<li><code>isOptimize = true</code> || <code>配置proxy-target-class=&quot;true&quot;</code> || <code>没有实现任何接口或者实现的接口是SpringProxy接口</code></li>
<li>目标类不是接口</li>
<li>不是通过<code>getProxyClass</code> 或 <code>newProxyInstance</code>获取的类</li>
</ul>
</li>
</ol>
<h4 id="AOP代理之JDK动态代理"><a href="#AOP代理之JDK动态代理" class="headerlink" title="AOP代理之JDK动态代理"></a>AOP代理之JDK动态代理</h4><p>由<code>createAopProxy</code>可知，AOP实现代理的方式有两种：JDK动态代理和CGLIB代理。下面讲解一下JDK动态代理。</p>
<h5 id="getProxy源码-1"><a href="#getProxy源码-1" class="headerlink" title="getProxy源码"></a>getProxy源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Creating JDK dynamic proxy: target source is "</span> + <span class="keyword">this</span>.advised.getTargetSource());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取所有要代理的接口</span></span><br><span class="line">        Class[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(<span class="keyword">this</span>.advised, <span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//寻找要代理接口方法中有没有equals和hashCode方法，有，做标记。同时都有时，寻找结束。</span></span><br><span class="line">        <span class="keyword">this</span>.findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取代理对象。由于JdkDynamicAopProxy类继承了InvocationHandler接口，因此在调用newProxyInstance方法传递第三个参数时，直接传递JdkDynamicAopProxy类本身即可</span></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(classLoader, proxiedInterfaces, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="invoke源码"><a href="#invoke源码" class="headerlink" title="invoke源码"></a>invoke源码</h5><p>在JDK动态代理中， <code>InvocationHandler接口</code>和 <code>Proxy类</code>是实现我们动态代理所必须用到的。当我们通过代理对象调用一个方法的时候，这个方法的调用就会被转发为由InvocationHandler这个接口的 invoke 方法来进行调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object oldProxy = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> setProxyContext = <span class="keyword">false</span>;</span><br><span class="line">        TargetSource targetSource = <span class="keyword">this</span>.advised.targetSource;</span><br><span class="line">        Class targetClass = <span class="keyword">null</span>;</span><br><span class="line">        Object target = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        Object retVal;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//以下两个if语句表明：equals方法与hashCode方法即使满足expression规则，也不会为之产生代理内容，调用的是JdkDynamicAopProxy的equals方法与hashCode方法</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">this</span>.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">                <span class="comment">// The target does not implement the equals(Object) method itself.</span></span><br><span class="line">                Boolean retVal3 = Boolean.valueOf(<span class="keyword">this</span>.equals(args[<span class="number">0</span>]));</span><br><span class="line">                <span class="keyword">return</span> retVal3;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">this</span>.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">                <span class="comment">// The target does not implement the hashCode() method itself.</span></span><br><span class="line">                Integer retVal2 = Integer.valueOf(<span class="keyword">this</span>.hashCode());</span><br><span class="line">                <span class="keyword">return</span> retVal2;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(method.getDeclaringClass() == DecoratingProxy.class) &#123;</span><br><span class="line">                Class retVal1 = AopProxyUtils.ultimateTargetClass(<span class="keyword">this</span>.advised);</span><br><span class="line">                <span class="keyword">return</span> retVal1;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.advised.opaque || !method.getDeclaringClass().isInterface() || !method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.advised.exposeProxy) &#123; </span><br><span class="line">                    <span class="comment">// Make invocation available if necessary.</span></span><br><span class="line">                    oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">                    setProxyContext = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                target = targetSource.getTarget();</span><br><span class="line">                <span class="keyword">if</span>(target != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    targetClass = target.getClass();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//获取AdvisedSupport中的所有拦截器和动态拦截器列表，用于拦截方法</span></span><br><span class="line">                List chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">                <span class="keyword">if</span>(chain.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//如果拦截器列表为空，即某个类/接口下的某个方法可能不满足expression的匹配规则，因此此时通过反射直接调用该方法。</span></span><br><span class="line">                    Object[] returnType = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">                    retVal = AopUtils.invokeJoinpointUsingReflection(target, method, returnType);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//如果拦截器列表不为空，需要一个ReflectiveMethodInvocation，并通过proceed方法对原方法进行拦截。</span></span><br><span class="line">                    ReflectiveMethodInvocation invocation = <span class="keyword">new</span> ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">                    retVal = invocation.proceed();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Class returnType1 = method.getReturnType();</span><br><span class="line">                <span class="keyword">if</span>(retVal != <span class="keyword">null</span> &amp;&amp; retVal == target &amp;&amp; returnType1 != Object.class &amp;&amp; returnType1.isInstance(proxy) &amp;&amp; !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">                    retVal = proxy;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(retVal == <span class="keyword">null</span> &amp;&amp; returnType1 != Void.TYPE &amp;&amp; returnType1.isPrimitive()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(<span class="string">"Null return value from advice does not match primitive return type for: "</span> + method);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Object var13 = retVal;</span><br><span class="line">                <span class="keyword">return</span> var13;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//方法所属的Class是一个接口并且方法所属的Class是AdvisedSupport的父类或者父接口，直接通过反射调用该方法。</span></span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(<span class="keyword">this</span>.advised, method, args);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(target != <span class="keyword">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">                targetSource.releaseTarget(target);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(setProxyContext) &#123;</span><br><span class="line">                AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="AOP代理之CGLIB代理"><a href="#AOP代理之CGLIB代理" class="headerlink" title="AOP代理之CGLIB代理"></a>AOP代理之CGLIB代理</h4><h5 id="getProxy源码-2"><a href="#getProxy源码-2" class="headerlink" title="getProxy源码"></a>getProxy源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Creating CGLIB proxy: target source is "</span> + <span class="keyword">this</span>.advised.getTargetSource());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class ex = <span class="keyword">this</span>.advised.getTargetClass();</span><br><span class="line">            Assert.state(ex != <span class="keyword">null</span>, <span class="string">"Target class must be available for creating a CGLIB proxy"</span>);</span><br><span class="line">            Class proxySuperClass = ex;</span><br><span class="line">            <span class="keyword">int</span> x;</span><br><span class="line">            <span class="keyword">if</span>(ClassUtils.isCglibProxyClass(ex)) &#123;</span><br><span class="line">                proxySuperClass = ex.getSuperclass();</span><br><span class="line">                Class[] enhancer = ex.getInterfaces();</span><br><span class="line">                Class[] callbacks = enhancer;</span><br><span class="line">                <span class="keyword">int</span> types = enhancer.length;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(x = <span class="number">0</span>; x &lt; types; ++x) &#123;</span><br><span class="line">                    Class additionalInterface = callbacks[x];</span><br><span class="line">                    <span class="keyword">this</span>.advised.addInterface(additionalInterface);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.validateClassIfNecessary(proxySuperClass, classLoader);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//获取Enhancer对象，这个CGLIB代理实现中重要的类</span></span><br><span class="line">            Enhancer var12 = <span class="keyword">this</span>.createEnhancer();</span><br><span class="line">            <span class="keyword">if</span>(classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var12.setClassLoader(classLoader);</span><br><span class="line">                <span class="keyword">if</span>(classLoader <span class="keyword">instanceof</span> SmartClassLoader &amp;&amp; ((SmartClassLoader)classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">                    var12.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var12.setSuperclass(proxySuperClass);</span><br><span class="line">            var12.setInterfaces(AopProxyUtils.completeProxiedInterfaces(<span class="keyword">this</span>.advised));</span><br><span class="line">            var12.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">            var12.setStrategy(<span class="keyword">new</span> CglibAopProxy.ClassLoaderAwareUndeclaredThrowableStrategy(classLoader));</span><br><span class="line">            Callback[] var13 = <span class="keyword">this</span>.getCallbacks(ex);</span><br><span class="line">            Class[] var14 = <span class="keyword">new</span> Class[var13.length];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(x = <span class="number">0</span>; x &lt; var14.length; ++x) &#123;</span><br><span class="line">                var14[x] = var13[x].getClass();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var12.setCallbackFilter(<span class="keyword">new</span> CglibAopProxy.ProxyCallbackFilter(<span class="keyword">this</span>.advised.getConfigurationOnlyCopy(), <span class="keyword">this</span>.fixedInterceptorMap, <span class="keyword">this</span>.fixedInterceptorOffset));</span><br><span class="line">            var12.setCallbackTypes(var14);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//生成代理类</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.createProxyClassAndInstance(var12, var13);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CodeGenerationException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"Could not generate CGLIB subclass of class ["</span> + <span class="keyword">this</span>.advised.getTargetClass() + <span class="string">"]: Common causes of this problem include using a final class or a non-visible class"</span>, var9);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var10) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"Could not generate CGLIB subclass of class ["</span> + <span class="keyword">this</span>.advised.getTargetClass() + <span class="string">"]: Common causes of this problem include using a final class or a non-visible class"</span>, var10);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">"Unexpected AOP exception"</span>, var11);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="createProxyClassAndInstance源码"><a href="#createProxyClassAndInstance源码" class="headerlink" title="createProxyClassAndInstance源码"></a>createProxyClassAndInstance源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createProxyClassAndInstance</span><span class="params">(Enhancer enhancer, Callback[] callbacks)</span> </span>&#123;</span><br><span class="line">        enhancer.setInterceptDuringConstruction(<span class="keyword">false</span>);</span><br><span class="line">        enhancer.setCallbacks(callbacks);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.constructorArgs != <span class="keyword">null</span>?enhancer.create(<span class="keyword">this</span>.constructorArgTypes, <span class="keyword">this</span>.constructorArgs):enhancer.create();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>关于Cglib，可以参考 <a href="http://www.cnblogs.com/xrq730/p/6661692.html" target="_blank" rel="noopener">Cglib及其基本使用
</a> 一文。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://houlong123.github.io/2017/08/22/Spring-AOP源码学习/" data-id="cjew9wqrw00291c0mugx4biaj" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/08/25/Mysql修改表主键/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          Mysql修改表主键
        
      </div>
    </a>
  
  
    <a href="/2017/08/19/IO学习/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">IO学习</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dokuwiki部署/">dokuwiki部署</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java基础集合/">java基础集合</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java并发/">java并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java并发锁/">java并发锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java并发集合/">java并发集合</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/部署GitHub-Page/">部署GitHub Page</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Mysql/" style="font-size: 11.67px;">Mysql</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/dokuwiki部署/" style="font-size: 10px;">dokuwiki部署</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/java/" style="font-size: 16.67px;">java</a> <a href="/tags/java基础集合/" style="font-size: 20px;">java基础集合</a> <a href="/tags/java并发/" style="font-size: 13.33px;">java并发</a> <a href="/tags/java并发锁/" style="font-size: 16.67px;">java并发锁</a> <a href="/tags/java并发集合/" style="font-size: 18.33px;">java并发集合</a> <a href="/tags/部署GitHub-Page/" style="font-size: 10px;">部署GitHub Page</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/18/JVM-学习/">JVM 学习</a>
          </li>
        
          <li>
            <a href="/2018/02/26/TreeMap源码学习/">TreeMap源码学习</a>
          </li>
        
          <li>
            <a href="/2018/02/24/LinkedHashMap源码学习/">LinkedHashMap源码学习</a>
          </li>
        
          <li>
            <a href="/2018/02/02/HashMap源码学习/">HashMap源码学习</a>
          </li>
        
          <li>
            <a href="/2018/01/30/AbstractMap源码学习/">AbstractMap源码学习</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 houlong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
  <a href="https://github.com/houlong123"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1000;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
</body>
</html>
